* =====================================================================
* LiFi-PV Receiver — Co-Simulation Netlist
* Generated by cosim.pipeline (using FullSystemNetlist subcircuits)
* Config: kadirvelu2021
* =====================================================================
* Channel gain:    G_ch = 7.723440e-02
* P_rx (avg):      718.28 uW
* I_ph (avg):      328.25 uA
* PWL source:      C:/Users/HP OMEN/OneDrive/Desktop/gradproject/components level sim/hardware_faithful_simulator/hardware_faithful_simulator/workspace/session_20260224_014324_ber_test/pwl/optical_power.pwl
* =====================================================================

.TITLE LiFi_PV_CoSim_kadirvelu2021

* =====================================================================
* SUBCIRCUIT DEFINITIONS
* =====================================================================
* =============================================================
* Solar Cell Equivalent Circuit (GaAs, KXOB25-04X3F equivalent)
* Cj = 798.0 nF, Rsh = 138.8 kohm
* R_lambda = 0.457 A/W
* =============================================================
.SUBCKT SOLAR_CELL anode cathode photo_in
* photo_in: voltage representing received optical power (1V = 1W)
* Photocurrent: Iph = R_lambda * P_optical

* Photocurrent source (controlled by optical input)
Gph cathode anode_int VALUE = {V(photo_in) * 0.457}

* Series resistance
Rs anode_int anode 2.5

* Junction capacitance
Cj anode_int cathode 7.980000e-07

* Shunt resistance
Rsh anode_int cathode 138800.0

* Junction diode (single-diode model)
D1 anode_int cathode SOLAR_D
.MODEL SOLAR_D D(IS=1e-10 N=1.5 RS=0.01)

.ENDS SOLAR_CELL

* =============================================================
* INA322 Instrumentation Amplifier - Behavioral Model
* Gain = 100.5 (40.0 dB)
* GBW = 700 kHz, f_3dB = 7.0 kHz
* R1 = 191k, R2 = 10k
* REF pin sets output common-mode (typically Vref = VCC/2)
* =============================================================
.SUBCKT INA322 INP INN OUT VCC VEE REF

* High input impedance
Rinp INP 0 1G
Rinn INN 0 1G
Rref REF 0 1G

* Differential gain stage
Ediff diff_int 0 INP INN 100.50

* Pole 1 (dominant): f = 6965 Hz
Rp1 diff_int p1 1k
Cp1 p1 0 2.285010e-08

* Pole 2 (non-dominant): f = 69652 Hz
Rp2 p1 p2 1k
Cp2 p2 0 2.285010e-09

* Output buffer with REF offset and rail clamping
* V_out = G*(Vinp - Vinn) + V(REF), clamped to rails
Bout OUT 0 V = MAX(MIN(V(p2) + V(REF), V(VCC)-0.05), V(VEE)+0.05)

.ENDS INA322

* =============================================================
* Band-Pass Filter Stage (TLV2379-based)
* HP corner: 146 Hz (Chp=33000.0pF, Rhp=33k)
* LP corner: 10610 Hz (Cfb=1.5nF, Rfb=10k)
* Passband gain: 1x (inverting)
* =============================================================
.SUBCKT BPF_STAGE inp out vcc vee vref

* --- High-pass section (AC coupling) ---
Chp inp hp_out 3.300000e-08
Rhp hp_out vref 33000

* --- Active low-pass filter (inverting) ---
Rin hp_out opamp_inn 10000
Rfb opamp_inn out 10000
Cfb opamp_inn out 1.500000e-09

* --- Op-amp: TLV2379 (GBW=100kHz) ---
* Simplified single-pole behavioral model
Ediff_oa oa_diff 0 vref opamp_inn 100000
Rpole_oa oa_diff oa_pole 1k
Cpole_oa oa_pole 0 1.59n
Bout_oa out 0 V = MAX(MIN(V(oa_pole), V(vcc)-0.02), V(vee)+0.02)

.ENDS BPF_STAGE

* =============================================================
* TLV7011 Comparator - Behavioral Model
* Propagation delay: 260 ns
* =============================================================
.SUBCKT COMPARATOR INP INN OUT VCC VEE

* High input impedance
Rinp INP 0 1T
Rinn INN 0 1T

* Comparator decision
Bcomp comp_int 0 V = IF(V(INP)-V(INN) > 0, V(VCC), V(VEE))

* Propagation delay (RC: tau = 260ns)
Rdel comp_int del_out 1k
Cdel del_out 0 260p

* Output buffer
Eout OUT 0 del_out 0 1

.ENDS COMPARATOR

* =============================================================
* Boost DC-DC Converter
* L = 22.0 uH, Cp = 10.0 uF
* CL = 47.0 uF, Rload = 180.0 kohm
* Switch: NTS4409 (Rds_on = 52 mohm)
* =============================================================
.SUBCKT BOOST_DCDC vin vout gnd phi

* Input capacitor
Cp vin gnd 1.000000e-05

* Inductor (with DCR = 0.5 ohm)
L1 vin sw 2.200000e-05
R_dcr sw sw2 0.5

* NMOS switch (NTS4409)
M1 sw2 phi gnd gnd NTS4409_SW W=1m L=1u
.MODEL NTS4409_SW NMOS(VTO=0.8 KP=200m RD=0.026 RS=0.026)

* Schottky diode
Ds sw2 vout SCHOTTKY_BOOST
.MODEL SCHOTTKY_BOOST D(IS=1e-5 N=1.05 RS=0.1 CJO=50p VJ=0.3 BV=40)

* Output capacitor
Cl vout gnd 4.700000e-05

* Load resistor
Rload vout gnd 180000

.ENDS BOOST_DCDC


* =====================================================================
* POWER SUPPLIES
* =====================================================================
Vcc vcc 0 DC 3.3
Vee vee 0 DC 0
Vref vref 0 DC 1.65

* =====================================================================
* OPTICAL INPUT (PWL bridge from channel model)
* =====================================================================
* V(optical_power) represents received optical power in W (1V = 1W)
Voptical optical_power 0 PWL file="C:/Users/HP OMEN/OneDrive/Desktop/gradproject/components level sim/hardware_faithful_simulator/hardware_faithful_simulator/workspace/session_20260224_014324_ber_test/pwl/optical_power.pwl"

* =====================================================================
* RECEIVER - DATA PATH
* =====================================================================

* --- Solar Cell ---
Xsc sc_anode sc_cathode optical_power SOLAR_CELL

* --- Current Sense Resistor ---
Rsense sc_cathode sense_lo 1.0

* --- Ground reference ---
Vgnd_ref sense_lo 0 DC 0

* --- INA322 Instrumentation Amplifier (40 dB) ---
* INP=sense_lo (0V), INN=sc_cathode (negative) → positive output + Vref offset
Xina sense_lo sc_cathode ina_out vcc vee vref INA322

* --- Band-Pass Filter Stage 1 ---
Xbpf1 ina_out bpf1_out vcc vee vref BPF_STAGE

* --- Band-Pass Filter Stage 2 ---
Xbpf2 bpf1_out bpf_out vcc vee vref BPF_STAGE

* --- Comparator (Data Recovery) ---
Xcomp bpf_out vref dout vcc vee COMPARATOR

* --- Output measurement ---
Rout_data dout 0 1MEG

* =====================================================================
* DC-DC CONVERTER (Power Path)
* =====================================================================
* Switching clock (fsw = 50 kHz)
Vphi phi 0 PULSE(0 3.3 0 10n 10n 1.000000e-05 2.000000e-05)

* Boost converter
Xdcdc sc_anode dcdc_out 0 phi BOOST_DCDC

* DC-DC output measurement
Rout_dcdc dcdc_out 0 1MEG

* =====================================================================
* SIMULATION COMMANDS
* =====================================================================
.tran 1.00e-05 1.00e-02 0 1.00e-05
.OPTIONS reltol=0.001 abstol=1e-12 vntol=1e-6

* Measurements
.MEAS TRAN v_ina_rms RMS V(ina_out) FROM=5.00e-03 TO=1.00e-02
.MEAS TRAN v_bpf_rms RMS V(bpf_out) FROM=5.00e-03 TO=1.00e-02
.MEAS TRAN v_bpf_pp PP V(bpf_out) FROM=5.00e-03 TO=1.00e-02
.MEAS TRAN v_sc_avg AVG V(sc_anode) FROM=5.00e-03 TO=1.00e-02
.MEAS TRAN v_dcdc_avg AVG V(dcdc_out) FROM=5.00e-03 TO=1.00e-02

.END
